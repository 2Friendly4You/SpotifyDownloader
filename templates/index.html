<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="description"
        content="Effortlessly download your favorite Spotify songs and playlists with our Spotify Downloader. High-quality audio, multiple formats, and easy-to-use interface. Try now!">
    <meta name="msapplication-TileImage" content="/images/SpotifyDownloader.png">
    <meta property="og:site_name" content="Spotify Downloader">
    <meta property="og:title" content="Spotify Downloader">
    <meta property="og:description"
        content="Effortlessly download your favorite Spotify songs and playlists with our Spotify Downloader. High-quality audio, multiple formats, and easy-to-use interface. Try now!">
    <meta property="og:image" itemprop="image" content="/images/SpotifyDownloader.png">
    <meta property="og:type" content="website" />
    <meta property="og:image:type" content="image/png">
    <meta property="og:image:width" content="300">
    <meta property="og:image:height" content="300">
    <meta property="og:url" content="https://sd.codemagie.xyz/">
    <link rel="icon" href="/images/SpotifyDownloader.png" type="image/png">
    <link rel="apple-touch-icon" sizes="300x300" href="/images/SpotifyDownloader.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0">

    <title>Spotify Downloader: Download Songs & Playlists Easily</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-8J4JDM8GTP"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-8J4JDM8GTP');
    </script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8210237740497045"
        crossorigin="anonymous"></script>

    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>

    <style>
        :root[data-theme="light"] {
            --text: #020302;
            --background: #fcfdfc;
            --primary: #47ff47;
            --secondary: #d0e2d0;
            --accent: #588d58;
            --input-bg: #ffffff;
            --border-color: #e0e0e0;
        }

        :root[data-theme="dark"] {
            --text: #fcfdfc;
            --background: #020302;
            --primary: #00b800;
            --secondary: #1d2f1d;
            --accent: #72a772;
            --input-bg: #1a1a1a;
            --border-color: #333333;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            word-wrap: break-word;
            font-family: 'Roboto', sans-serif;
            color: var(--text);
            background-color: var(--background);
            font-size: 16px;
            line-height: 1.6;
            padding: 20px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 800px;
            padding: 0 15px;
        }

        h1, h2, h3 {
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        input, select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--input-bg);
            color: var(--text);
            font-size: 1rem;
        }

        button {
            background: var(--primary);
            color: var(--background);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        /* Remove width: 100% from default button style and add it specifically where needed */
        .full-width {
            width: 100%;
        }

        .btn-success {
            background: var(--accent);
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            display: inline-block; /* Change from block to inline-block */
            min-width: 100px; /* Set a minimum width */
        }

        button:hover {
            opacity: 0.9;
        }

        #requests-list {
            list-style: none;
            padding: 0;
        }

        #requests-list li {
            display: flex;
            align-items: center;
            justify-content: space-between; /* Better spacing control */
            gap: 1rem;
            padding: 1rem;
            background: var(--secondary);
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .spinner-border {
            width: 20px;
            height: 20px;
            border: 2px solid var(--text);
            border-right-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            font-size: 0;  /* Hide any text inside spinner */
            flex-shrink: 0; /* Prevent spinner from being squished */
            margin: 0 0 0 auto; /* Fix margin alignment */
        }

        #clear-history {
            margin-bottom: 1.5rem;
            background: #dc3545;
            width: auto;
            padding: 0.75rem 1.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .lightMode {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--accent);
            color: var(--background);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .faq-section {
            margin-top: 2rem;
        }

        .faq-section h3 {
            margin-top: 1.5rem;
        }

        .faq-section p {
            margin-bottom: 1rem;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
                font-size: 14px;
            }

            .container {
                padding: 0 10px;
            }

            button {
                padding: 0.6rem 1.2rem;
            }

            #requests-list li {
                flex-direction: column;
                align-items: flex-start;
            }

            .btn-success {
                width: auto; /* Override the full width on mobile */
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Spotify Downloader</h1>
        <form id="search-form">
            <div class="form-group">
                <label for="search_query">Search for a song or URL</label>
                <input type="text" id="search_query" placeholder="Enter a song or URL">
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label for="audio_format">Audio provider</label>
                    <select id="audio_format">
                        <option value="youtube-music">YouTube Music</option>
                        <option value="youtube">YouTube</option>
                        <option value="slider-kz">slider.kz</option>
                        <option value="soundcloud">SoundCloud</option>
                        <option value="bandcamp">Bandcamp</option>
                        <option value="piped">Piped</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="lyrics_format">Lyrics provider</label>
                    <select id="lyrics_format">
                        <option value="musixmatch">musixmatch</option>
                        <option value="genius">genius</option>
                        <option value="azlyrics">azlyrics</option>
                        <option value="synced">synced</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="output_format">Output format</label>
                    <select id="output_format">
                        <option value="mp3">MP3</option>
                        <option value="m4a">M4A</option>
                        <option value="wav">WAV</option>
                        <option value="flac">FLAC</option>
                        <option value="ogg">OGG</option>
                        <option value="opus">OPUS</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>&nbsp;</label>
                    <button type="button" id="download-button" class="full-width">Search</button>
                </div>
            </div>
        </form>

        <div class="mt-3">
            <h2>Requests</h2>
            <button class="btn btn-danger mb-2" id="clear-history">Clear History</button>
            <ul id="requests-list">
                <!-- Requests will be added here dynamically -->
            </ul>
        </div>
        <br>
        <h3>Download counter</h3>
        <span><span id="downloadCounter"></span> Songs/ Playlists were already downloaded</p>
            <br>
            <div class="faq-section">
                <h3>FAQ</h3>
                <p><b>How do I download songs?</b></p>
                <p>Enter a song title or URL and press Search. Once the song is found, click Download.</p>
                <p><b>How do I download playlists?</b></p>
                <p>You can download playlists by entering a playlist URL. The playlist must be public.</p>
                <p><b>What are Audio Providers?</b></p>
                <p>Audio Providers are the sources, where the audio is downloaded from (it is not directly downloaded
                    from
                    Spotify). If you don't know what to choose, select "Youtube Music"</p>
                <p><b>What are Lyrics Providers?</b></p>
                <p>Lyrics Providers are the sources, where the lyrics are downloaded from.</p>
                <p><b>What are Output Formats?</b></p>
                <p>Output Formats are the formats, the audio is converted to. If you don't know what to choose, select
                    MP3.
                </p>
                <p><b>How to ensure the best audio quality?</b></p>
                <p>I personally recommend to choose "Youtube Music" as Audio Provider.</p>
                <p><b>Why has my download an error.txt file inside?</b></p>
                <p>This is, because an error occured, when trying to download this song. It propably is not available.
                    Try
                    using another Audio Provider.</p>
                <p><b>Why is my download pending?</b></p>
                <p>This is because the song is currently being downloaded. Please wait a few minutes. If you are
                    searching
                    for a playlist, the process can easily take up to 10-20 minutes.</p>
                <p><b>Why is there an error next to my search query instead of the loading symbol?</b></p>
                <p>This is, because you have downloaded too many songs in a short period of time. Please wait a minute
                    and try again. The cap currently is 1 per 5 seconds and 10 per minute.</p>
                <br>
                <h3>Disclaimer</h3>
                <p>This Spotify downloader is legal for personal use only. The music may not be distributed or played in
                    public.</p>
            </div>
    </div>
    <br><br>
    <button class="lightMode" onclick="changeLightMode()">
        <span class="material-symbols-outlined">
            settings_brightness
        </span>
    </button>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            let requestIdCounter = 0;
            const socket = io({
                reconnection: true,
                reconnectionDelay: 1000,
                reconnectionDelayMax: 5000,
                reconnectionAttempts: Infinity
            });
            const pendingDownloads = new Map();

            // Load only user's downloads from local storage
            const loadDownloadHistory = () => {
                const userDownloads = JSON.parse(localStorage.getItem('userDownloads') || '[]');
                userDownloads.forEach(item => {
                    // Add to pending downloads map
                    pendingDownloads.set(item.unique_id, item.searchQuery);
                    
                    // Add to UI as pending
                    const requestItem = `<li id="${item.unique_id}">
                        <span>${item.searchQuery} (Checking status...)</span>
                        <div class="spinner-border" role="status"></div>
                    </li>`;
                    $("#requests-list").append(requestItem);
                });
            };

            // Save download to user's storage
            const saveDownload = (unique_id, searchQuery, url) => {
                const userDownloads = JSON.parse(localStorage.getItem('userDownloads') || '[]');
                // Remove any existing entry for this unique_id
                const filteredDownloads = userDownloads.filter(d => d.unique_id !== unique_id);
                filteredDownloads.push({ unique_id, searchQuery, url });
                localStorage.setItem('userDownloads', JSON.stringify(filteredDownloads));
            };

            // Clear user's download history
            $("#clear-history").click(function() {
                localStorage.removeItem('userDownloads');
                $("#requests-list").empty();
            });

            // Socket.IO event handlers
            socket.on('connect', function() {
                console.log('Connected to server');
                loadDownloadHistory();
            });

            socket.on('download_complete', function(data) {
                console.log('Download complete:', data);
                // Only process if it's in our pending downloads
                if (pendingDownloads.has(data.unique_id)) {
                    const searchQuery = pendingDownloads.get(data.unique_id);
                    updateRequestItem(data.unique_id, searchQuery, data.url);
                    saveDownload(data.unique_id, searchQuery, data.url);
                    pendingDownloads.delete(data.unique_id);
                }
            });

            socket.on('download_status', function(data) {
                const userDownloads = JSON.parse(localStorage.getItem('userDownloads') || '[]');
                const userDownloadIds = new Set(userDownloads.map(d => d.unique_id));

                // Only handle downloads that belong to this user
                data.completed.forEach(download => {
                    if (userDownloadIds.has(download.unique_id)) {
                        updateRequestItem(download.unique_id, 
                                       pendingDownloads.get(download.unique_id), 
                                       download.url);
                    }
                });

                data.pending.forEach(download => {
                    if (userDownloadIds.has(download.unique_id)) {
                        const existingItem = $(`#${download.unique_id}`);
                        if (existingItem.length && !existingItem.find('.spinner-border').length) {
                            existingItem.find('span').text(`${pendingDownloads.get(download.unique_id)} (Pending)`);
                            existingItem.append('<div class="spinner-border" role="status"></div>');
                        }
                    }
                });
            });

            socket.on('disconnect', function() {
                console.log('Disconnected from server, attempting to reconnect...');
            });

            socket.on('reconnect', function() {
                console.log('Reconnected to server');
                // Server will send updated status on reconnection
            });

            // Utility function to display alerts
            const showAlert = async (title, text, cookieName) => {
                if (getCookie(cookieName) === "") {
                    const { value: accept } = await Swal.fire({
                        title,
                        color: 'black',
                        icon: 'info',
                        text,
                        input: 'checkbox',
                        inputValue: 0,
                        inputPlaceholder: 'Do not show again',
                        confirmButtonText: 'OK',
                    });
                    if (accept) {
                        setCookie(cookieName, true, 365);
                    }
                }
            };

            // Initialize download process
            const initiateDownload = async () => {
                const searchQuery = $("#search_query").val().trim();
                const audioFormat = $("#audio_format").val().trim();
                const lyricsFormat = $("#lyrics_format").val().trim();
                const outputFormat = $("#output_format").val().trim();

                if (!searchQuery || !outputFormat) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: 'Please provide a search query and select an output format!',
                    });
                    return;
                }

                if (searchQuery.includes("https://open.spotify.com/playlist/")) {
                    await showAlert('Info...', 'Downloading a playlist can take a few minutes.', "playlistNotification");
                } else if (!searchQuery.includes("https://open.spotify.com/track/")) {
                    await showAlert('Info...', 'Search queries are often very imprecise. Please use links if you want to get accurate results.', "trackNotification");
                }

                // Submit the download request
                $.post('/search', {
                    search_query: searchQuery,
                    audio_format: audioFormat,
                    lyrics_format: lyricsFormat,
                    output_format: outputFormat
                })
                .done(function(data) {
                    console.log('Search response:', data);
                    if (data.status === 'success' && data.unique_id) {
                        // Add to pending downloads
                        pendingDownloads.set(data.unique_id, searchQuery);
                        saveDownload(data.unique_id, searchQuery); // Save immediately
                        
                        // Add to UI
                        const requestItem = `<li id="${data.unique_id}"><span>${searchQuery} (Pending)</span> <div class="spinner-border" role="status"></div></li>`;
                        $("#requests-list").append(requestItem);
                        
                        incrementDownloadCounter();
                    }
                })
                .fail(function(jqXHR, textStatus, errorThrown) {
                    console.error('Request failed:', errorThrown);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Failed to start download. Please try again.',
                    });
                });

                // Clear input after submission
                $("#search_query").val('');
            };

            // Update the request item in the UI
            const updateRequestItem = (requestId, searchQuery, url) => {
                const existingItem = $(`#${requestId}`);
                if (existingItem.length) {
                    existingItem.find('span').text(`${searchQuery} (Completed)`);
                    existingItem.find('.spinner-border').remove();
                    if (!existingItem.find('.btn-success').length) {
                        existingItem.append(`
                            <button class="btn btn-success" onclick="startDownload('${url}', '${searchQuery}')">Download</button>
                        `);
                    }
                } else {
                    const requestItem = `
                        <li id="${requestId}">
                            <span>${searchQuery} (Completed)</span>
                            <button class="btn btn-success" onclick="startDownload('${url}', '${searchQuery}')">Download</button>
                        </li>`;
                    $("#requests-list").append(requestItem);
                }
            };

            // Event handlers for form submission
            $("#search-form").submit(function (event) {
                event.preventDefault();
                initiateDownload();
            });

            $("#download-button").click(function () {
                initiateDownload();
            });

            $("#search_query").keypress(function (e) {
                if (e.which === 13) {
                    e.preventDefault();
                    initiateDownload();
                }
            });

            // Add event listener for search query input
            $("#search_query").on('input', function() {
                updateProviders($(this).val());
            });
        });

        function updateProviders(searchQuery) {
            const isYouTubeUrl = /^(https?:\/\/)?(www\.)?(youtube\.com|youtu\.be)\/.+$/.test(searchQuery);
            const audioFormatSelect = $("#audio_format");
            const lyricsFormatSelect = $("#lyrics_format");
            const outputFormatSelect = $("#output_format");
            
            if (isYouTubeUrl) {
                audioFormatSelect.html('<option value="yt-dlp">YouTube Downloader</option>');
                audioFormatSelect.prop('disabled', true);
                lyricsFormatSelect.prop('disabled', true);
                outputFormatSelect.prop('disabled', false);
            } else {
                audioFormatSelect.html(`
                    <option value="youtube-music">YouTube Music</option>
                    <option value="youtube">YouTube</option>
                    <option value="slider-kz">slider.kz</option>
                    <option value="soundcloud">SoundCloud</option>
                    <option value="bandcamp">Bandcamp</option>
                    <option value="piped">Piped</option>
                `);
                audioFormatSelect.prop('disabled', false);
                lyricsFormatSelect.prop('disabled', false);
                outputFormatSelect.prop('disabled', false);
            }
        }

        // Add function for background download
        function startDownload(url, filename) {
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = url;
            document.body.appendChild(iframe);
            
            // Remove the iframe after a short delay
            setTimeout(() => {
                document.body.removeChild(iframe);
            }, 2000);

            // Show success message
            Swal.fire({
                title: 'Download Started',
                text: `Downloading ${filename}...`,
                icon: 'success',
                timer: 2000,
                showConfirmButton: false
            });
        }
    </script>
    <script>
        function setCookie(cname, cvalue, exdays) {
            const d = new Date();
            d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
            let expires = "expires=" + d.toUTCString();
            document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
        }

        function getCookie(cname) {
            const name = cname + "=";
            const decodedCookie = decodeURIComponent(document.cookie);
            const ca = decodedCookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) == ' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(name) == 0) {
                    return c.substring(name.length, c.length);
                }
            }
            return "";
        }

        function checkCookie() {
            let user = getCookie("username");
            if (user != "") {
                alert("Welcome again " + user);
            } else {
                user = prompt("Please enter your name:", "");
                if (user != "" && user != null) {
                    setCookie("username", user, 365);
                }
            }
        }

        function eraseCookie(name) {
            document.cookie = name + '=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
        }
    </script>
    <script>
        // save to local storage
        function changeLightMode() {
            if (localStorage.getItem("lightMode") == "true") {
                localStorage.setItem("lightMode", "false");
            } else {
                localStorage.setItem("lightMode", "true");
            }
            setLightMode();
        }

        // load from local storage
        function setLightMode() {
            if (localStorage.getItem("lightMode") == "true") {
                document.documentElement.setAttribute('data-theme', 'light');
            } else {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        }

        // check if light mode is set
        if (localStorage.getItem("lightMode") == null) {
            localStorage.setItem("lightMode", "false");
        }

        setLightMode();
    </script>
    <script>
        // download counter
        $.get('/download_counter', function (data) {
            $("#downloadCounter").text(data);
        });

        function incrementDownloadCounter() {
            // just increment the counter locally
            $("#downloadCounter").text(parseInt($("#downloadCounter").text()) + 1);
        }
    </script>
</body>

</html>